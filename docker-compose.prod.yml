services:
  # Production: All-in-one container with frontend served by backend
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        DATABASE_URL: file:/app/server/data/dev.db
        VITE_API_BASE_URL: http://localhost:4000
        VITE_ADMIN_TOKEN: ${API_ADMIN_TOKEN:-devhub-local-admin-token}
        VITE_HF_API_KEY: ${HF_API_KEY}
        VITE_GITHUB_TOKEN: ${GITHUB_TOKEN}
        VITE_GITHUB_OWNER: ${GITHUB_OWNER:-yourgodfather12}
    container_name: devhub-app
    ports:
      - "${PORT:-4000}:4000"
    environment:
      NODE_ENV: production
      PORT: 4000
      DATABASE_URL: file:/app/server/data/dev.db

      # API Configuration
      API_ADMIN_TOKEN: ${API_ADMIN_TOKEN:-devhub-local-admin-token}
      SERVE_STATIC_ASSETS: "true"
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:4000}
      API_PROXY_ALLOWLIST: ${API_PROXY_ALLOWLIST:-}

      # GitHub Integration
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      GITHUB_OWNER: ${GITHUB_OWNER:-yourgodfather12}
      GITHUB_OWNER_ALLOWLIST: ${GITHUB_OWNER_ALLOWLIST:-yourgodfather12}

      # Vercel Integration
      VERCEL_TOKEN: ${VERCEL_TOKEN:-}
      VERCEL_TEAM_ID: ${VERCEL_TEAM_ID:-}

      # Supabase Integration
      SUPABASE_ACCESS_TOKEN: ${SUPABASE_ACCESS_TOKEN:-}
      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-}

      # Hugging Face
      HF_API_KEY: ${HF_API_KEY}
      HF_API_URL: ${HF_API_URL:-https://router.huggingface.co/v1/chat/completions}
      HF_MODEL_ID: ${HF_MODEL_ID:-meta-llama/Meta-Llama-3.1-8B-Instruct}

    volumes:
      - devhub_db:/app/server/data
      - devhub_logs:/app/server/logs
    networks:
      - devhub
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:4000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  devhub:
    driver: bridge

volumes:
  devhub_db:
    driver: local
  devhub_logs:
    driver: local
